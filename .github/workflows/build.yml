name: 'Check updates and build'

on:
  workflow_dispatch: 
  schedule:
    - cron: '0 0 * * 0'

permissions: 
  contents:  write
  packages: write

jobs:
  check:
    name: Check updates
    runs-on: ubuntu-latest
    outputs:  
      VERSION_UPDATED:  ${{ steps.check.outputs.VERSION_UPDATED }}
      VERSION: ${{ steps.check.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
        name: Checkout files
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth:  0

      - name: Install jq
        run:  sudo apt-get update && sudo apt-get install -y jq

      - id: check
        name: Run check script
        run:  |
          chmod +x check.sh
          ./check.sh

      - uses: actions-js/push@master
        name:  Commit & Push changes
        if:  steps.check.outputs.VERSION_UPDATED == 1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          message: "ci: shadowbox updated `${{ steps.check.outputs.VERSION }}`"

  build:
    name: Build image
    runs-on: ubuntu-latest
    needs: check
    if: needs.check.outputs.VERSION_UPDATED == 1
    steps: 
      - uses: actions/checkout@v4
        name: Checkout files
        
      - uses: actions/checkout@v4
        name:  Checkout shadowbox files
        with:
          repository: 'Jigsaw-Code/outline-server'
          ref: "server-v${{ needs.check.outputs.VERSION }}"
          path: shadowbox

      - name:  Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses:  docker/setup-buildx-action@v3

      - name:  Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
    
      - uses: actions/setup-node@v4
        with:
          node-version: 'lts/hydrogen'
      
      - uses: actions/setup-go@v5
        with:
          go-version: '^1.21'
        
      - name: Install go task
        run: sudo npm i -g @go-task/cli

      - name: Install dependencies
        working-directory: shadowbox
        run: npm i

      - name: Verify VERSION is set
        run: |
          VERSION="${{ needs.check.outputs.VERSION }}"
          echo "VERSION='$VERSION'"
          if [ -z "$VERSION" ] || [ "$VERSION" == "null" ]; then
            echo "ERROR: VERSION is not set correctly!"
            exit 1
          fi

      - name: Run image build task
        working-directory: shadowbox
        env: 
          SB_VERSION:  ${{ needs.check.outputs. VERSION }}
        run: |
          echo "=== Build Configuration ==="
          echo "VERSION parameter: ${{ needs.check.outputs.VERSION }}"
          echo "SB_VERSION env var: $SB_VERSION"
          echo "=========================="
          task shadowbox:docker:build TARGET_ARCH=arm64 IMAGE_NAME=shadowbox VERSION=${{ needs.check.outputs.VERSION }} --verbose


      - name: Verify version in image
        run: |
          echo "Expected version: ${{ needs.check.outputs.VERSION }}"
          # Check the version label on the Docker image
          docker inspect shadowbox:latest | jq '.[0].Config.Labels'
          # Try to extract version from the built JavaScript
          docker run --rm shadowbox: latest sh -c "grep -o '__VERSION__: \"[^\"]*\"' /opt/outline-server/app/main.js | head -1" || echo "Could not find version in bundle"
          # Alternative: Check if the version appears anywhere in the compiled code
          docker run --rm shadowbox:latest sh -c "strings /opt/outline-server/app/main.js | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | head -5" || echo "No version strings found"

      - name: Push built docker image
        env:
          VERSION:  ${{ needs.check.outputs.VERSION }}
        run: |
          echo "Pushing version: $VERSION"
          
          docker tag shadowbox:latest ghcr.io/infinity6542/shadowbox:latest
          docker tag shadowbox:latest ghcr.io/infinity6542/shadowbox:$VERSION
          
          docker push ghcr.io/infinity6542/shadowbox:latest
          docker push ghcr.io/infinity6542/shadowbox:$VERSION
